#!/bin/bash

# Automatically prepend issue number from branch name to commit message
# Supports branch names like:
#   feat/36-add-new-button
#   docs/func-spec/6-create-markdown-template
#   docs/6-create-markdown-template

commit_msg_file="$1"
commit_source="$2"

branch_name=$(git rev-parse --abbrev-ref HEAD)
issue_number=$(echo "$branch_name" | sed -nE 's|.*/([0-9]+)-.*|\1|p')

# Handle "Revert" commits
if grep -q '^Revert "' "$commit_msg_file"; then
    sed -i '' 's/^Revert /revert: /' "$commit_msg_file"
    sed -i '' 's/"//g' "$commit_msg_file"
fi

# Skip merge or squash commits
if [ "$commit_source" = "merge" ] || [ "$commit_source" = "squash" ]; then
    exit 0
fi

# Prepend issue number if present and not already there
if [ -n "$issue_number" ]; then
    if ! grep -q "#$issue_number" "$commit_msg_file"; then
        first_line=$(head -n1 "$commit_msg_file")
        rest=$(tail -n +2 "$commit_msg_file")

        echo "(#$issue_number) ${first_line}" > "$commit_msg_file"
        echo "$rest" >> "$commit_msg_file"
    fi
fi
